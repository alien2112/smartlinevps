{
	"info": {
		"_postman_id": "customer-otp-flow-2024",
		"name": "SmartLine - Customer OTP Flow",
		"description": "Complete OTP flow testing for new customer registration, login, and password reset.\n\n## Flow Overview\n1. Registration ‚Üí OTP sent\n2. Verify OTP ‚Üí Get token\n3. OTP Login (alternative)\n4. Forget Password ‚Üí OTP sent\n5. Reset Password with OTP\n\n## Setup\n1. Set `base_url` variable to your API URL\n2. Run requests in order\n3. OTP will be sent via Rateel OTP API",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"variable": [
		{
			"key": "base_url",
			"value": "https://your-domain.com",
			"type": "string"
		},
		{
			"key": "test_phone",
			"value": "+201234567890",
			"type": "string"
		},
		{
			"key": "test_email",
			"value": "testcustomer@example.com",
			"type": "string"
		},
		{
			"key": "test_password",
			"value": "TestPass123!",
			"type": "string"
		},
		{
			"key": "otp_code",
			"value": "000000",
			"type": "string"
		},
		{
			"key": "auth_token",
			"value": "",
			"type": "string"
		}
	],
	"item": [
		{
			"name": "1. Registration Flow",
			"item": [
				{
					"name": "1.1 Check User Exists",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200 or 403', function () {",
									"    pm.expect(pm.response.code).to.be.oneOf([200, 403]);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"if (pm.response.code === 403) {",
									"    pm.test('User does not exist - ready for registration', function () {",
									"        pm.expect(jsonData.response_code).to.include('404');",
									"    });",
									"    console.log('‚úÖ Phone not registered. Ready to create new account.');",
									"} else {",
									"    pm.test('User exists', function () {",
									"        pm.expect(jsonData.user).to.not.be.undefined;",
									"    });",
									"    console.log('‚ö†Ô∏è User already exists. Use a different phone number.');",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"{{test_phone}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/check",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "check"]
						},
						"description": "Check if phone number is already registered.\n\n**Expected Response (User Not Found):**\n```json\n{\n    \"response_code\": \"user_not_found_404\",\n    \"message\": \"User not found\"\n}\n```"
					}
				},
				{
					"name": "1.2 Register New Customer",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.expect(pm.response.code).to.equal(200);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"pm.test('Registration successful', function () {",
									"    pm.expect(jsonData.response_code).to.equal('registration_200');",
									"});",
									"",
									"console.log('‚úÖ Registration successful! OTP sent to phone.');",
									"console.log('üì± Check your phone for OTP code.');",
									"console.log('üí° In dev mode, OTP is 000000');"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Generate unique email to avoid duplicates",
									"var timestamp = Date.now();",
									"pm.collectionVariables.set('test_email', 'test' + timestamp + '@example.com');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"first_name\": \"Test\",\n    \"last_name\": \"Customer\",\n    \"email\": \"{{test_email}}\",\n    \"phone\": \"{{test_phone}}\",\n    \"password\": \"{{test_password}}\",\n    \"gender\": \"male\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/registration",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "registration"]
						},
						"description": "Register a new customer account.\n\n**Required Fields:**\n- `first_name`: Customer's first name\n- `last_name`: Customer's last name\n- `email`: Valid email (must be unique)\n- `phone`: Phone with country code (+201234567890)\n- `password`: Min 8 characters\n- `gender`: 'male' or 'female'\n\n**Optional Fields:**\n- `profile_image`: Image file\n- `referral_code`: Referral code from another user\n- `fcm_token`: Firebase Cloud Messaging token\n\n**Response:** OTP sent to phone number"
					}
				},
				{
					"name": "1.3 Verify OTP (Complete Registration)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.expect(pm.response.code).to.equal(200);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"pm.test('OTP verified successfully', function () {",
									"    pm.expect(jsonData.response_code).to.equal('auth_login_200');",
									"});",
									"",
									"pm.test('Token received', function () {",
									"    pm.expect(jsonData.content.token).to.not.be.undefined;",
									"});",
									"",
									"// Save token for future requests",
									"if (jsonData.content && jsonData.content.token) {",
									"    pm.collectionVariables.set('auth_token', jsonData.content.token);",
									"    console.log('‚úÖ OTP Verified! Token saved.');",
									"    console.log('üîë Token: ' + jsonData.content.token.substring(0, 50) + '...');",
									"}",
									"",
									"console.log('üìä User Status:');",
									"console.log('   - Phone Verified: ' + jsonData.content.is_phone_verified);",
									"console.log('   - Active: ' + jsonData.content.is_active);",
									"console.log('   - Profile Verified: ' + jsonData.content.is_profile_verified);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"{{test_phone}}\",\n    \"otp\": \"{{otp_code}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/otp-verification",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "otp-verification"]
						},
						"description": "Verify OTP received via SMS.\n\n**Note:** In development mode, OTP is `000000`\n\n**Success Response:**\n```json\n{\n    \"response_code\": \"auth_login_200\",\n    \"message\": \"Login successful\",\n    \"content\": {\n        \"token\": \"eyJ0eXAiOiJKV1Qi...\",\n        \"is_active\": 1,\n        \"is_phone_verified\": 1,\n        \"is_profile_verified\": 1\n    }\n}\n```"
					}
				}
			]
		},
		{
			"name": "2. OTP Login Flow",
			"item": [
				{
					"name": "2.1 Request OTP for Login",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.expect(pm.response.code).to.equal(200);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"pm.test('OTP sent successfully', function () {",
									"    pm.expect(jsonData.response_code).to.equal('default_200');",
									"});",
									"",
									"console.log('‚úÖ OTP sent to phone.');",
									"console.log('üì± Check SMS for OTP code.');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"{{test_phone}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/otp-login",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "otp-login"]
						},
						"description": "Request OTP for passwordless login.\n\n**Use Case:** Customer wants to login with OTP instead of password."
					}
				},
				{
					"name": "2.2 Verify OTP and Login",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.expect(pm.response.code).to.equal(200);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"if (jsonData.content && jsonData.content.token) {",
									"    pm.collectionVariables.set('auth_token', jsonData.content.token);",
									"    console.log('‚úÖ Login successful! Token saved.');",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"{{test_phone}}\",\n    \"otp\": \"{{otp_code}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/otp-verification",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "otp-verification"]
						},
						"description": "Verify OTP to complete login."
					}
				}
			]
		},
		{
			"name": "3. Resend OTP",
			"item": [
				{
					"name": "3.1 Resend OTP",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"",
									"if (pm.response.code === 200) {",
									"    pm.test('OTP resent successfully', function () {",
									"        pm.expect(jsonData.response_code).to.equal('default_200');",
									"    });",
									"    console.log('‚úÖ OTP resent to phone.');",
									"} else if (pm.response.code === 403) {",
									"    pm.test('Rate limited or error', function () {",
									"        pm.expect(jsonData.response_code).to.include('405');",
									"    });",
									"    console.log('‚è±Ô∏è Rate limited. Wait before resending.');",
									"    console.log('Message: ' + jsonData.message);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"{{test_phone}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/send-otp",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "send-otp"]
						},
						"description": "Resend OTP if not received or expired.\n\n**Rate Limiting:** Wait 60 seconds between resend requests."
					}
				}
			]
		},
		{
			"name": "4. Forget Password Flow",
			"item": [
				{
					"name": "4.1 Request Password Reset OTP",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.expect(pm.response.code).to.equal(200);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"pm.test('Password reset OTP sent', function () {",
									"    pm.expect(jsonData.response_code).to.equal('default_200');",
									"});",
									"",
									"console.log('‚úÖ Password reset OTP sent to phone.');",
									"console.log('üì± Check SMS for OTP code.');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"{{test_phone}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/forget-password",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "forget-password"]
						},
						"description": "Request OTP for password reset.\n\n**Use Case:** Customer forgot their password."
					}
				},
				{
					"name": "4.2 Reset Password with OTP",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.expect(pm.response.code).to.equal(200);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"pm.test('Password reset successful', function () {",
									"    pm.expect(jsonData.response_code).to.equal('default_password_reset_200');",
									"});",
									"",
									"console.log('‚úÖ Password reset successful!');",
									"console.log('üîê You can now login with your new password.');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"{{test_phone}}\",\n    \"otp\": \"{{otp_code}}\",\n    \"password\": \"NewPassword123!\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/reset-password",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "reset-password"]
						},
						"description": "Reset password using OTP received via SMS.\n\n**Required Fields:**\n- `phone_or_email`: Phone number or email\n- `otp`: 6-digit OTP from SMS\n- `password`: New password (min 8 characters)\n\n**Security:** OTP is verified before password change is allowed."
					}
				}
			]
		},
		{
			"name": "5. Authenticated Requests (After OTP Verification)",
			"item": [
				{
					"name": "5.1 Get User Profile",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.expect(pm.response.code).to.equal(200);",
									"});",
									"",
									"console.log('‚úÖ Profile retrieved successfully.');",
									"console.log('User: ' + JSON.stringify(pm.response.json(), null, 2));"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/customer/profile",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "profile"]
						},
						"description": "Get authenticated user's profile.\n\n**Requires:** Bearer token from OTP verification."
					}
				},
				{
					"name": "5.2 Logout",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.expect(pm.response.code).to.equal(200);",
									"});",
									"",
									"console.log('‚úÖ Logged out successfully.');",
									"pm.collectionVariables.set('auth_token', '');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{auth_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/user/logout",
							"host": ["{{base_url}}"],
							"path": ["api", "user", "logout"]
						},
						"description": "Logout and invalidate token."
					}
				}
			]
		},
		{
			"name": "6. Error Cases",
			"item": [
				{
					"name": "6.1 Invalid OTP",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 403', function () {",
									"    pm.expect(pm.response.code).to.equal(403);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"pm.test('OTP mismatch error', function () {",
									"    pm.expect(jsonData.response_code).to.include('404');",
									"});",
									"",
									"console.log('‚úÖ Correctly rejected invalid OTP.');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"{{test_phone}}\",\n    \"otp\": \"999999\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/otp-verification",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "otp-verification"]
						},
						"description": "Test with invalid OTP - should be rejected."
					}
				},
				{
					"name": "6.2 User Not Found",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 403', function () {",
									"    pm.expect(pm.response.code).to.equal(403);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"pm.test('User not found error', function () {",
									"    pm.expect(jsonData.response_code).to.include('404');",
									"});",
									"",
									"console.log('‚úÖ Correctly rejected non-existent user.');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"+201111111111\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/forget-password",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "forget-password"]
						},
						"description": "Test forget password with non-existent phone."
					}
				},
				{
					"name": "6.3 Reset Without OTP",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 403', function () {",
									"    pm.expect(pm.response.code).to.equal(403);",
									"});",
									"",
									"var jsonData = pm.response.json();",
									"",
									"pm.test('OTP required error', function () {",
									"    pm.expect(jsonData.response_code).to.include('400');",
									"});",
									"",
									"console.log('‚úÖ Correctly requires OTP for password reset.');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Accept",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"phone_or_email\": \"{{test_phone}}\",\n    \"password\": \"NewPassword123!\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/customer/auth/reset-password",
							"host": ["{{base_url}}"],
							"path": ["api", "customer", "auth", "reset-password"]
						},
						"description": "Test password reset without OTP - should fail."
					}
				}
			]
		}
	]
}
